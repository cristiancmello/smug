#!/bin/bash

DEBUG=true

debug_latest_cmd() {
  FNNAME=$1
  RETURN=$2
  
  if [[ "$DEBUG" == true ]]; then
    echo ">>> ${FNNAME} exit with $RETURN"
  fi
}

debug_print() {
  if [[ "$DEBUG" == true ]]; then
    echo $@
  fi
}

debug_print_func_exec() {
  debug_print ">>> $1 executed"
}

detect_os() {
  debug_print "OSTYPE=$OSTYPE"
  
  case "$OSTYPE" in
    "linux-gnu")
      echo "0"
      ;;
    *)
      echo "-1"
  esac
  
  debug_print_func_exec ${FUNCNAME[0]}
}

detect_linux_distro() {
  source /etc/os-release
  
  debug_print $(cat /etc/os-release)
  debug_print "PRETTY_NAME=\"$PRETTY_NAME\""
  
  case "$PRETTY_NAME" in
    "Amazon Linux AMI 2018.03")
      echo "0"
      ;;
    *)
      echo "-1"
  esac
  
  debug_print_func_exec ${FUNCNAME[0]}
}

setup_php73() {
  sudo yum install -y \
    php73 \
    php73-devel \
    php73-mysql \
    php73-pdo \
    php73-mbstring \
    php73-gd \
    php73-xml \
    php73-xmlrpc \
    php73-mcrypt \
    php-pear
    
  debug_latest_cmd ${FUNCNAME[0]} $?
}

remove_php_already_installed() {
  sudo yum remove -y httpd* php* php-common* php-cli*
  
  debug_latest_cmd ${FUNCNAME[0]} $?
}

detect_os_result=$(detect_os)
debug_print $detect_os_result

detect_linux_distro_result=$(detect_linux_distro)
debug_print $detect_linux_distro_result

remove_php_already_installed_result=$(remove_php_already_installed)
debug_print -e $remove_php_already_installed_result

setup_php73_result=$(setup_php73)
debug_print -e $setup_php73_result